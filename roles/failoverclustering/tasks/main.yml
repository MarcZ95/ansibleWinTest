---
- name: install failover clustering
  win_feature:
    name:
      - Failover-Clustering
      - RSAT-Clustering-Mgmt
      - RSAT-Clustering-PowerShell
    state: present
    include_management_tools: yes
  register: clustering

- name: create cluster on first node
  community.windows.win_cluster:
    name: "{{ cluster_name}}"
    static_address: "{{ cluster_ip }}"
    nodes: "{{ cluster_nodes }}"
  when: inventory_hostname == cluster_nodes[0]

- name: add second node to cluster
  community.windows.win_cluster_node:
    name: "{{ cluster_node[1] }}"
    cluster_name: "{{ cluster_name }}"
  when: inventory_hostname == cluster_nodes[0]

- name: create cluster on first node
  ansible.windows.win_powershell:
    script: |
        $ClusterName = "{{ cluster_name }}"
        $ClusterIP   = "{{ cluster_ip }}"
        $Nodes       = "{{ cluster_nodes | join(',') }}"

        Write-Host "Creating cluster $ClusterName with nodes $Nodes and IP $ClusterIP..."
        New-Cluster -Name $ClusterName -Node $Nodes -StaticAddress $ClusterIP -NoStorage -Force
    creates: "C:\\Windows\\Cluster\\CLUSTER.INI"
  when: inventory_hostname == cluster_nodes[0]